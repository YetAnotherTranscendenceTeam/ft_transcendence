asyncapi: 3.0.0
info:
  title: Mathmaking Lobbies Service
  version: 1.0.0
  description: The websocket service for communication between the lobbies and matchmaking servers
servers:
  development:
    host: matchmaking:3000
    protocol: wss
    description: The matchmaking server (from inside the docker network)
channels:
  matchmaking:
    address: /matchmaking/lobbieconnection
    description: The channel for communication between the matchmaking server and the lobbies server
    messages:
    # lobbies -> matchmaking
      handshake:
        $ref: "#/components/messages/handshake"
      queue_lobby:
        $ref: "#/components/messages/queue_lobby"
      unqueue_lobby:
        $ref: "#/components/messages/unqueue_lobby"
    # matchmaking -> lobbies
      confirm_handshake:
        $ref: "#/components/messages/confirm_handshake"
      confirm_queue:
        $ref: "#/components/messages/confirm_queue"
      confirm_unqueue:
        $ref: "#/components/messages/confirm_unqueue"
      match:
        $ref: "#/components/messages/match"
operations:
  matchmaking_publish:
    action: receive
    summary: Send a message to the matchmaking server
    channel:
      $ref: "#/channels/matchmaking"
    messages:
      - $ref: "#/channels/matchmaking/messages/handshake"
      - $ref: "#/channels/matchmaking/messages/queue_lobby"
      - $ref: "#/channels/matchmaking/messages/unqueue_lobby"
  matchmaking_subscribe:
    action: send
    summary: Receive a message from the matchmaking server
    channel:
      $ref: "#/channels/matchmaking"
    messages:
      - $ref: "#/channels/matchmaking/messages/confirm_handshake"
      - $ref: "#/channels/matchmaking/messages/confirm_queue"
      - $ref: "#/channels/matchmaking/messages/confirm_unqueue"
      - $ref: "#/channels/matchmaking/messages/match"

components:
  schemas:
    match:
      type: number
      description: The match id (WIP)
  messages:
    handshake:
      description: A message sent to authenticate itself
      payload:
        type: object
        required:
          - event
          - data
        properties:
          event:
            type: string
            description: Event type
            enum:
              - handshake
          data:
            type: object
            required:
              - jwt
            properties:
              jwt:
                type: string
                description: |
                  A JWT generated by the lobbies server containing it's gamemode information.
                  If the gamemode list isn't the same as the server's or the JWT is invalid, the connection will be closed.
    confirm_handshake:
      description: A message sent to confirm the handshake
      payload:
        type: object
        required:
          - event
        properties:
          event:
            type: string
            description: Event type
            enum:
              - handshake
    queue_lobby:
      description: A message sent to queue a lobby
      payload:
        type: object
        required:
          - event
          - data
        properties:
          event:
            type: string
            description: Event type
            enum:
              - queue_lobby
          data:
            type: object
            required:
              - lobby
            properties:
              lobby:
                $ref: "./lobbies.yaml#/components/schemas/lobby"
    confirm_queue:
      description: A message sent to confirm the queue
      payload:
        type: object
        required:
          - event
          - data
        properties:
          event:
            type: string
            description: Event type
            enum:
              - confirm_queue
          data:
            type: object
            required:
              - lobby
              - queue_stats
            properties:
              lobby:
                $ref: "./lobbies.yaml#/components/schemas/lobby"
              queue_stats:
                type: object
                required:
                  - players
                  - lobbies
                properties:
                  players:
                    type: integer
                    description: The number of players in the queue
                  lobbies:
                    type: integer
                    description: The number of lobbies in the queue
    unqueue_lobby:
      description: A message sent to unqueue a lobby
      payload:
        type: object
        required:
          - event
          - data
        properties:
          event:
            type: string
            description: Event type
            enum:
              - unqueue_lobby
          data:
            type: object
            required:
              - lobby
            properties:
              lobby:
                $ref: "./lobbies.yaml#/components/schemas/lobby"
    confirm_unqueue:
      description: A message sent to confirm the unqueue
      payload:
        type: object
        required:
          - event
          - data
        properties:
          event:
            type: string
            description: Event type
            enum:
              - confirm_unqueue
          data:
            type: object
            required:
              - lobby
            properties:
              lobby:
                $ref: "./lobbies.yaml#/components/schemas/lobby"
    match:
      description: A message sent to match lobbies
      payload:
        type: object
        required:
          - event
          - data
        properties:
          event:
            type: string
            description: Event type
            enum:
              - match
          data:
            type: object
            required:
              - lobbies
              - match
            properties:
              lobbies:
                type: array
                items:
                  $ref: "./lobbies.yaml#/components/schemas/lobby"
              match:
                $ref: "#/components/schemas/match"
